<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0d1117">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Conduit">
<title>Conduit</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
<link rel="apple-touch-icon" href="icon-192.png">
</head>
<body>

<!-- ============================================================== -->
<!-- Onboarding wizard overlay                                       -->
<!-- ============================================================== -->
<div id="onboardingOverlay" class="hidden">
  <div class="onboard-card">
    <h2>Welcome to Conduit</h2>
    <p>Let's get your node set up in a few quick steps.</p>
    <div class="onboard-steps">
      <div class="onboard-step active" data-ob="1">1. Connect</div>
      <div class="onboard-step" data-ob="2">2. Fund</div>
      <div class="onboard-step" data-ob="3">3. Channel</div>
      <div class="onboard-step" data-ob="4">4. Browse</div>
    </div>

    <!-- Step 1: Connect -->
    <div class="onboard-section active" id="ob-step1">
      <p>Enter the URL of your Conduit node and the content registry.</p>
      <input class="onboard-input" id="obNodeUrl" placeholder="http://your-node:3000">
      <input class="onboard-input" id="obRegistryUrl" placeholder="http://registry:3003">
      <div class="onboard-status" id="obConnStatus"></div>
      <div class="onboard-nav">
        <span></span>
        <button class="btn btn-primary" onclick="obConnect()">Connect</button>
      </div>
    </div>

    <!-- Step 2: Fund -->
    <div class="onboard-section" id="ob-step2">
      <p>Fund your node's on-chain wallet so you can open Lightning channels.</p>
      <div class="onboard-addr" id="obFundAddr" onclick="obCopyAddr()" title="Click to copy">Loading address...</div>
      <div class="onboard-balance" id="obBalance">0 sats</div>
      <div class="onboard-status" id="obFundStatus" style="text-align:center;">Waiting for on-chain deposit...</div>
      <div class="onboard-nav">
        <button class="btn btn-secondary" onclick="obGoStep(1)">Back</button>
        <button class="btn btn-primary" id="obFundNext" onclick="obGoStep(3)">Next</button>
      </div>
    </div>

    <!-- Step 3: Open Channel -->
    <div class="onboard-section" id="ob-step3">
      <p>Open a Lightning channel to start buying content. Pick a suggested peer or enter one manually.</p>
      <div id="obPeerBtns" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;"></div>
      <input class="onboard-input" id="obChNodeId" placeholder="Peer Node ID">
      <input class="onboard-input" id="obChAddr" placeholder="Peer address (host:port)">
      <input class="onboard-input" id="obChAmount" type="number" min="20000" value="100000" placeholder="Channel size (sats)">
      <div class="onboard-status" id="obChStatus"></div>
      <div class="onboard-nav">
        <button class="btn btn-secondary" onclick="obGoStep(2)">Back</button>
        <button class="btn btn-primary" id="obChBtn" onclick="obOpenChannel()">Open Channel</button>
      </div>
    </div>

    <!-- Step 4: Browse -->
    <div class="onboard-section" id="ob-step4">
      <p style="font-size:15px;color:#3fb950;font-weight:600;text-align:center;margin-bottom:16px;">You're all set!</p>
      <p>Your node is connected, funded, and has a Lightning channel. You can now browse and buy content.</p>
      <div class="onboard-nav" style="justify-content:center;">
        <button class="btn btn-primary" onclick="obFinish()">Start Browsing</button>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================== -->
<!-- Header                                                          -->
<!-- ============================================================== -->
<div class="header">
  <h1>CONDUIT</h1>
  <span id="nodeStatusBadge" style="font-size:11px;padding:3px 10px;border-radius:12px;background:#21262d;color:#8b949e;">offline</span>
  <span class="node-id dev-only" id="nodeId">connecting...</span>
</div>

<!-- ============================================================== -->
<!-- Wallet bar (always visible)                                     -->
<!-- ============================================================== -->
<div class="wallet-bar" id="walletBar">
  <div class="stat"><span class="stat-label">On-chain:</span> <span class="stat-value btc" id="wOnchain">--</span> <span class="stat-label">sats</span></div>
  <div class="stat"><span class="stat-label">Lightning:</span> <span class="stat-value btc" id="wLightning">--</span> <span class="stat-label">sats</span></div>
  <div class="stat"><span class="stat-label">Channels:</span> <span class="stat-value" id="wChannels">--</span></div>
</div>

<!-- ============================================================== -->
<!-- Tab bar                                                         -->
<!-- ============================================================== -->
<div class="tab-bar" id="tabBar">
  <button class="active" data-tab="wallet">Wallet</button>
  <button data-tab="creator">Creator</button>
  <button data-tab="library">Library</button>
  <button data-tab="collection">Collection</button>
  <button class="dev-only" data-tab="seeder">Seeder</button>
  <button class="dev-only" data-tab="advertiser">Advertiser</button>
  <button class="dev-only" data-tab="network">Network</button>
  <button class="dev-only" data-tab="events">Events</button>
  <button data-tab="settings">Settings</button>
</div>

<!-- ============================================================== -->
<!-- TAB: Wallet                                                     -->
<!-- ============================================================== -->
<div class="tab-content active" id="tab-wallet">
  <div class="card dev-only dev-only-block">
    <h3>Node Identity</h3>
    <p class="mono" id="walletNodeId">--</p>
    <div id="p2pInfoBlock" style="display:none;margin-top:8px;padding:8px 12px;background:rgba(0,255,136,0.08);border-radius:8px;border:1px solid rgba(0,255,136,0.2);">
      <span style="color:var(--green);font-weight:600;font-size:0.75rem;">P2P ENABLED</span>
      <p class="mono" style="font-size:0.7rem;margin-top:4px;" id="p2pNodeId">--</p>
    </div>
  </div>
  <div class="card">
    <h3>On-chain Wallet</h3>
    <div style="display:flex;gap:16px;margin-bottom:12px;">
      <div><span class="stat-label">Total: </span><span class="stat-value btc" id="walletOnchain">--</span> sats</div>
      <div><span class="stat-label">Spendable: </span><span class="stat-value" id="walletSpendable">--</span> sats</div>
    </div>
    <p style="font-size:12px;color:#8b949e;">Funding address (click to copy):</p>
    <p class="mono" id="walletAddress" style="margin-top:4px;cursor:pointer;" onclick="copyAddress()" title="Click to copy">--</p>
    <button class="btn btn-secondary" style="margin-top:8px;font-size:11px;" onclick="fetchAddress()">New Address</button>
  </div>
  <div class="card">
    <h3>Lightning Channels</h3>
    <table id="channelTable">
      <tr><th>Peer</th><th>Capacity</th><th>Outbound</th><th>Inbound</th><th>Status</th><th></th></tr>
    </table>
    <p class="empty" id="noChannels">No channels yet</p>
  </div>
  <div class="card">
    <h3>Open Channel</h3>
    <p style="font-size:12px;color:#8b949e;margin-bottom:12px;">
      Connect to a peer and fund a new Lightning channel.
    </p>
    <div id="peerSuggestions" style="margin-bottom:12px;display:none;">
      <label style="font-size:11px;color:#8b949e;display:block;margin-bottom:6px;">Suggested peers (from registry)</label>
      <div id="peerList" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
    </div>
    <div style="display:flex;gap:8px;align-items:end;flex-wrap:wrap;">
      <div style="flex:2;min-width:200px;">
        <label style="font-size:11px;color:#8b949e;display:block;margin-bottom:4px;">Peer Node ID</label>
        <input id="openChNodeId" placeholder="02abc...def" style="width:100%;background:#0d1117;border:1px solid #30363d;color:#e6edf3;padding:8px 10px;border-radius:6px;font-family:inherit;font-size:13px;">
      </div>
      <div style="flex:1;min-width:140px;">
        <label style="font-size:11px;color:#8b949e;display:block;margin-bottom:4px;">Address (host:port)</label>
        <input id="openChAddr" placeholder="1.2.3.4:9735" style="width:100%;background:#0d1117;border:1px solid #30363d;color:#e6edf3;padding:8px 10px;border-radius:6px;font-family:inherit;font-size:13px;">
      </div>
      <div style="width:120px;">
        <label style="font-size:11px;color:#8b949e;display:block;margin-bottom:4px;">Amount (sats)</label>
        <input id="openChAmount" type="number" min="20000" value="100000" style="width:100%;background:#0d1117;border:1px solid #30363d;color:#e6edf3;padding:8px 10px;border-radius:6px;font-family:inherit;font-size:13px;">
      </div>
      <button class="btn btn-primary" id="openChBtn" onclick="openChannel()">Open Channel</button>
    </div>
    <div id="openChStatus" style="margin-top:8px;font-size:12px;color:#8b949e;"></div>
  </div>
</div>

<!-- ============================================================== -->
<!-- TAB: Creator                                                    -->
<!-- ============================================================== -->
<div class="tab-content" id="tab-creator">
  <div class="card">
    <h3>Publish Content</h3>
    <p style="font-size:12px;color:#8b949e;margin-bottom:12px;">
      Publish a file for sale on the Conduit network.
    </p>
    <div style="display:flex;gap:8px;align-items:end;flex-wrap:wrap;">
      <div style="flex:1;min-width:200px;">
        <label style="font-size:11px;color:#8b949e;display:block;margin-bottom:4px;">File path</label>
        <input id="regFilePath" placeholder="/data/media/my-content.mp4" style="width:100%;background:#0d1117;border:1px solid #30363d;color:#e6edf3;padding:8px 10px;border-radius:6px;font-family:inherit;font-size:13px;">
      </div>
      <div style="width:120px;">
        <label style="font-size:11px;color:#8b949e;display:block;margin-bottom:4px;">Price (sats)</label>
        <input id="regPrice" type="number" min="1" value="50" style="width:100%;background:#0d1117;border:1px solid #30363d;color:#e6edf3;padding:8px 10px;border-radius:6px;font-family:inherit;font-size:13px;">
      </div>
      <button class="btn btn-primary" onclick="registerContent()">Publish</button>
    </div>
    <div id="regStatus" style="margin-top:8px;font-size:12px;color:#8b949e;"></div>
  </div>
  <div class="card">
    <h3>My Catalog <button class="btn btn-secondary" style="float:right;font-size:11px;padding:4px 10px;" onclick="loadCreatorCatalog()">Refresh</button></h3>
    <table id="creatorCatalogTable">
      <tr><th>File</th><th>Price</th><th>Size</th><th class="dev-only dev-only-table-cell">Hash</th></tr>
    </table>
    <p class="empty" id="noCreatorCatalog">No content published yet</p>
  </div>
</div>

<!-- ============================================================== -->
<!-- TAB: Library (Buyer)                                            -->
<!-- ============================================================== -->
<div class="tab-content" id="tab-library">
  <div class="card">
    <h3>Browse Catalog <button class="btn btn-secondary" style="float:right;font-size:11px;padding:4px 10px;" onclick="loadCatalog()">Refresh</button></h3>
    <div id="libraryCatalog">
      <p class="empty" id="noLibraryCatalog">Enter a Registry URL in Settings to browse content</p>
    </div>
  </div>

  <div class="card" id="buyCard" style="display:none;">
    <h3 id="buyTitle">--</h3>
    <p id="buyMeta" style="font-size:12px;color:#8b949e;margin-bottom:8px;">--</p>
    <p class="mono dev-only dev-only-block" id="buyHash" style="margin-bottom:12px;">--</p>
    <p class="dev-only dev-only-block" style="font-size:11px;color:#484f58;margin-bottom:8px;" id="buyCreatorAddr">--</p>

    <div id="deviceNotice" style="display:none;background:#2a1f0e;border:1px solid #4a3520;border-radius:8px;padding:8px 12px;margin-bottom:8px;font-size:12px;color:#f0883e;">
      This content requires a verified TEE device for playback.
    </div>

    <input type="hidden" name="buyMode" value="pre">
    <input type="hidden" id="sourceMode" value="smart">
    <div class="dev-only dev-only-block" style="margin-bottom:8px;">
      <details id="advancedSourceDetails">
        <summary style="cursor:pointer;font-size:12px;color:#8b949e;">Advanced source options</summary>
        <div style="margin-top:6px;display:flex;flex-direction:column;gap:6px;">
          <div class="mode-row" style="display:flex;gap:8px;flex-wrap:wrap;">
            <label><input type="radio" name="sourceSelect" value="smart" checked> Smart (ICS)</label>
            <label><input type="radio" name="sourceSelect" value="creator"> Creator only</label>
            <label><input type="radio" name="sourceSelect" value="seeder"> Specific seeder</label>
          </div>
          <select id="seederPicker" style="display:none;font-size:12px;padding:4px;background:#161b22;color:#c9d1d9;border:1px solid #30363d;border-radius:4px;"></select>
          <div id="icsInfo" style="font-size:11px;color:#8b949e;"></div>
        </div>
      </details>
    </div>
    <div class="mode-row dev-only dev-only-flex" style="gap:8px;flex-wrap:wrap;">
      <label><input type="radio" name="buyMode" value="pre" checked> PRE</label>
      <label><input type="radio" name="buyMode" value="direct"> Direct</label>
      <label><input type="radio" name="buyMode" value="seeder"> Seeder</label>
      <label><input type="radio" name="buyMode" value="chunked"> Chunked</label>
      <label><input type="radio" name="buyMode" value="ad"> Free (ad)</label>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn btn-primary" id="buyBtn" disabled>Buy</button>
    </div>

    <!-- Progress steps -->
    <div id="buyProgress" style="display:none;margin-top:16px;"></div>

    <!-- Result -->
    <div id="buyResult" style="display:none;margin-top:12px;padding:12px;border-radius:8px;font-size:13px;"></div>

    <!-- Preview -->
    <div class="preview-container" id="buyPreview" style="display:none;"></div>
  </div>
</div>

<!-- ============================================================== -->
<!-- TAB: Collection                                                  -->
<!-- ============================================================== -->
<div class="tab-content" id="tab-collection">
  <div class="card">
    <h3>My Collection <button class="btn btn-secondary" style="float:right;font-size:11px;padding:4px 10px;" onclick="renderCollection()">Refresh</button></h3>
    <p style="font-size:12px;color:#8b949e;margin-bottom:12px;">Content you have purchased. Stored in your browser.</p>
    <div id="collectionList"></div>
    <p class="empty" id="noCollection">No purchases yet. Buy content from the Library tab.</p>
  </div>
</div>

<!-- ============================================================== -->
<!-- TAB: Seeder                                                     -->
<!-- ============================================================== -->
<div class="tab-content" id="tab-seeder">
  <div class="card">
    <h3>Register Seed</h3>
    <p style="font-size:12px;color:#8b949e;margin-bottom:12px;">
      Register encrypted content to seed. Provide the path to the encrypted file, its hash, and the transport price you want to charge.
    </p>
    <div style="display:flex;gap:8px;align-items:end;flex-wrap:wrap;">
      <div style="flex:1;min-width:200px;">
        <label style="font-size:11px;color:#8b949e;display:block;margin-bottom:4px;">Encrypted file path (on node)</label>
        <input id="seedFilePath" placeholder="/path/to/encrypted.enc" style="width:100%;background:#0d1117;border:1px solid #30363d;color:#e6edf3;padding:8px 10px;border-radius:6px;font-family:inherit;font-size:13px;">
      </div>
      <div style="flex:1;min-width:200px;">
        <label style="font-size:11px;color:#8b949e;display:block;margin-bottom:4px;">Encrypted hash H(E)</label>
        <input id="seedEncHash" placeholder="abcdef1234..." style="width:100%;background:#0d1117;border:1px solid #30363d;color:#e6edf3;padding:8px 10px;border-radius:6px;font-family:inherit;font-size:13px;">
      </div>
      <div style="width:120px;">
        <label style="font-size:11px;color:#8b949e;display:block;margin-bottom:4px;">Transport price (sats)</label>
        <input id="seedPrice" type="number" min="1" value="10" style="width:100%;background:#0d1117;border:1px solid #30363d;color:#e6edf3;padding:8px 10px;border-radius:6px;font-family:inherit;font-size:13px;">
      </div>
      <button class="btn btn-primary" onclick="registerSeed()">Seed</button>
    </div>
    <div id="seedStatus" style="margin-top:8px;font-size:12px;color:#8b949e;"></div>
  </div>
  <div class="card">
    <h3>Active Seeds <button class="btn btn-secondary" style="float:right;font-size:11px;padding:4px 10px;" onclick="loadSeederInfo()">Refresh</button></h3>
    <table id="seederTable">
      <tr><th>File</th><th>Chunks</th><th>Transport Price</th><th>Encrypted Hash</th></tr>
    </table>
    <p class="empty" id="noSeeds">No content being seeded yet</p>
  </div>
</div>

<!-- ============================================================== -->
<!-- TAB: Advertiser                                                 -->
<!-- ============================================================== -->
<div class="tab-content" id="tab-advertiser">
  <div class="card">
    <h3>Advertiser Role</h3>
    <p style="font-size:12px;color:#8b949e;margin-bottom:8px;">
      Run third-party ad campaigns. Advertisers are external parties (brands, businesses)
      who pay to show their ads to buyers in exchange for subsidizing content purchases.
    </p>
    <div id="advStatus" style="margin-top:12px;"></div>
    <div id="advEnableHint" style="display:none;margin-top:8px;">
      <p style="font-size:12px;color:#8b949e;">
        Enable by starting the node with <code style="color:#79c0ff;">--ads-dir /path/to/ads</code>
      </p>
      <p style="font-size:11px;color:#484f58;margin-top:4px;">
        Place ad creatives (mp4, webm, png, jpg) in the directory. A default campaign is auto-created from the first file found.
      </p>
    </div>
  </div>
  <div class="card">
    <h3>My Campaigns <button class="btn btn-secondary" style="float:right;font-size:11px;padding:4px 10px;" onclick="loadAdvertiserInfo()">Refresh</button></h3>
    <table id="advCampaignTable">
      <tr><th>Name</th><th>Subsidy/View</th><th>Budget Used</th><th>Budget Total</th><th>Duration</th><th>Status</th></tr>
    </table>
    <p class="empty" id="noCampaigns">No campaigns yet</p>
  </div>
  <div class="card" id="advStatsCard" style="display:none;">
    <h3>Payment Stats</h3>
    <div style="display:flex;gap:24px;flex-wrap:wrap;">
      <div><span class="stat-label">Total paid: </span><span class="stat-value btc" id="advTotalPaid">0</span> sats</div>
      <div><span class="stat-label">Payments: </span><span class="stat-value" id="advPaymentCount">0</span></div>
    </div>
  </div>
  <div class="card">
    <h3>Advertiser Identity</h3>
    <p style="font-size:12px;color:#8b949e;">Ed25519 Pubkey (for attestation signatures):</p>
    <p class="mono" id="advPubkey">--</p>
  </div>
</div>

<!-- ============================================================== -->
<!-- TAB: Network                                                    -->
<!-- ============================================================== -->
<div class="tab-content" id="tab-network">
  <div class="card">
    <h3>Network Topology</h3>
    <p style="font-size:12px;color:#8b949e;margin-bottom:12px;">
      Lightning channels (solid lines) and content distribution (dashed lines) across all discovered nodes.
    </p>
    <div id="networkGraph" style="height:520px;">
      <div class="net-tooltip" id="netTooltip"></div>
    </div>
    <div class="net-legend" id="netLegend">
      <div class="net-legend-item"><div class="net-legend-dot" style="background:#f0883e;"></div>This Node</div>
      <div class="net-legend-item"><div class="net-legend-dot" style="background:#58a6ff;"></div>Creator</div>
      <div class="net-legend-item"><div class="net-legend-dot" style="background:#3fb950;"></div>Seeder</div>
      <div class="net-legend-item"><div class="net-legend-dot" style="background:#bc8cff;"></div>Advertiser</div>
      <div class="net-legend-item"><div class="net-legend-dot" style="background:#8b949e;"></div>Peer</div>
      <div class="net-legend-item"><span style="display:inline-block;width:24px;border-top:2px solid #8b949e;"></span>Channel</div>
      <div class="net-legend-item"><span style="display:inline-block;width:24px;border-top:2px dashed #30363d;"></span>Seeds content</div>
    </div>
    <div class="net-status" id="netStatus"></div>
  </div>
</div>

<!-- ============================================================== -->
<!-- TAB: Events                                                     -->
<!-- ============================================================== -->
<div class="tab-content" id="tab-events">
  <div class="event-filter" id="eventFilter">
    <button class="active" data-filter="all">All</button>
    <button data-filter="creator">Creator</button>
    <button data-filter="buyer">Buyer</button>
    <button data-filter="seeder">Seeder</button>
    <button data-filter="advertiser">Advertiser</button>
  </div>
  <div id="eventList" style="max-height:600px;overflow-y:auto;"></div>
  <p class="empty" id="noEvents">Waiting for events...</p>
</div>

<!-- ============================================================== -->
<!-- TAB: Settings                                                   -->
<!-- ============================================================== -->
<div class="tab-content" id="tab-settings">
  <div class="settings">
    <h3>Node Connection</h3>
    <div class="row"><label>Node URL</label><input id="settNodeUrl" placeholder="http://localhost:3000"></div>
    <div class="row"><label>Registry</label><input id="settRegistryUrl" placeholder="http://registry-ip:3003"></div>
    <div class="status" id="settStatus">Not connected</div>
    <button class="btn btn-primary" style="margin-top:10px;" onclick="connectNode()">Connect</button>
    <div class="dev-toggle">
      <input type="checkbox" id="devModeToggle" onchange="toggleDevMode(this.checked)">
      <label for="devModeToggle">Developer mode &mdash; show advanced tabs, raw hashes, and payment mode options</label>
    </div>
  </div>

  <div class="card dev-only dev-only-block" style="margin-top:16px;">
    <h3>Trusted Device Manufacturers</h3>
    <p style="color:#8b949e;font-size:12px;margin-bottom:12px;">
      Manufacturers on this list can provision TEE devices whose attestation your node will accept.
    </p>
    <div id="trustListContainer"><p class="empty">Loading...</p></div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <input id="trustPkHex" placeholder="Manufacturer public key (hex)" style="flex:2;background:#0d1117;border:1px solid #30363d;color:#e6edf3;padding:6px 10px;border-radius:6px;font-size:12px;font-family:'SF Mono',monospace;">
      <input id="trustName" placeholder="Name" style="flex:1;background:#0d1117;border:1px solid #30363d;color:#e6edf3;padding:6px 10px;border-radius:6px;font-size:13px;">
      <button class="btn btn-primary" onclick="addTrustedManufacturer()">Add</button>
    </div>
    <div class="status" id="trustStatus" style="margin-top:6px;"></div>
  </div>
</div>

<!-- ============================================================== -->
<!-- Ad overlay                                                      -->
<!-- ============================================================== -->
<div id="adOverlay">
  <video id="adVideo" playsinline></video>
  <div id="adTimer"></div>
  <div id="adProgressBar"><div class="fill" id="adProgressFill"></div></div>
</div>

<!-- ============================================================== -->
<!-- JavaScript (Vite module entry)                                  -->
<!-- ============================================================== -->
<script type="module" src="/src/main.js"></script>
</body>
</html>
